<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet Profile - Paw Care</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>body{font-family:'Poppins',sans-serif}.shadow-soft{box-shadow:0 4px 16px rgba(0,0,0,.05)}:root{--soft-teal:#199e9e}</style>
</head>
<body class="bg-[#f6f9f9] min-h-screen flex flex-col">
  <header class="w-full bg-[var(--soft-teal)] text-white flex items-center justify-between px-12 py-4 shadow-soft">
    <div class="flex items-center space-x-5"><img src="assets/logo.png" class="w-14 h-14 rounded-lg bg-white p-1 object-contain"><div><h1 class="text-2xl font-semibold">Paw Care Veterinary Clinic</h1><p class="text-sm text-gray-100/90">Caring for your pets with compassion and expertise</p></div></div>
    <button class="bg-white text-[var(--soft-teal)] px-5 py-2 rounded-md font-semibold hover:bg-gray-50" onclick="logout()">Logout</button>
  </header>

  <div class="flex flex-1">
    <aside class="w-72 bg-white border-r border-gray-200 p-6 shadow-soft">
      <h2 class="text-xl font-semibold text-[var(--soft-teal)] uppercase mb-4">Pet Profile</h2>
      <nav id="sidebarNav" class="flex flex-col space-y-2"></nav>
    </aside>

    <main class="flex-1 p-8">
      <div id="profileCard" class="bg-white rounded-2xl shadow-soft p-8"></div>
    </main>
  </div>

  <!-- Auto-detects backend, uses API mode when backend is available -->
  <script src="assets/api.js"></script>
  <script src="assets/app.js"></script>
  <script>
    ensureLoggedIn();
    const role = getRole();
    // Redirect pharmacist away from pet records
    if(role === 'pharmacist'){
      location.href = 'dashboard.html';
    }
    renderSidebar(document.getElementById('sidebarNav'), role, 'pet-records.html');

    const id=Number(new URLSearchParams(location.search).get('id'));
    function row(label,val){return `<div><div class="text-sm text-gray-500">${label}</div><div class="font-medium">${val||''}</div></div>`;}

    async function renderProfile(){
      const p=await repoGetPet(id);
      document.getElementById('profileCard').innerHTML=`
        <div class="flex items-start gap-8">
          <div class="w-40 h-40 rounded-xl bg-gray-100 border flex items-center justify-center text-gray-400 overflow-hidden">
            ${p?.photo?`<img src="${p.photo}" class="w-full h-full object-cover">`:'No Photo'}
          </div>
          <div class="flex-1">
            <h3 class="text-2xl font-semibold text-gray-800 mb-3">${p?.name||'Unknown Pet'}</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${row('Species',p?.species)} ${row('Breed',p?.breed)}
              ${row('Gender',p?.gender)}   ${row('Age',p?.age)}
              ${row('Microchip',p?.microchip)} ${row('Federation',p?.federation||'N/A')}
              ${row('Address',p?.address)}
            </div>

            <div class="mt-6 p-4 border rounded-xl bg-[#f7fbfb]">
              <div class="font-semibold mb-2">Owner</div>
              <div id="ownerCard" class="text-sm text-gray-700">Loading owner...</div>
            </div>

            <div class="mt-6 flex gap-3">
              <button class="px-4 py-2 border rounded-md" onclick="history.back()">Back</button>
              <button class="px-5 py-2 rounded-md bg-[var(--soft-teal)] text-white" onclick="location.href='pet-records.html'">Pet Records</button>
            </div>

            <hr class="my-8">

            <div class="flex items-center justify-between mb-3">
              <h4 class="text-xl font-semibold text-gray-800">Procedures</h4>
              <button class="px-4 py-2 rounded-md bg-[var(--soft-teal)] text-white" onclick="openProc()">Add Procedure</button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead><tr class="text-left text-gray-600 border-b"><th class="py-3">Performed At</th><th class="py-3">Category</th><th class="py-3">Name</th><th class="py-3">Notes</th><th class="py-3">Medications</th><th class="py-3">Dosage</th><th class="py-3">Directions</th><th class="py-3">Cost</th><th class="py-3">Actions</th></tr></thead>
                <tbody id="procRows">
                </tbody>
              </table>
              <div class="mt-3 text-right font-semibold">Total Cost: <span id="procTotal">0</span></div>
            </div>
          </div>
        </div>`;

      // Owner card render
      (async()=>{
        const el = document.getElementById('ownerCard');
        let ownerName = p?.owner||''; let phone=''; let email=''; let address='';
        if(p?.ownerId){ const o = await repoGetOwner(p.ownerId); if(o){ ownerName=o.fullName; phone=o.phone; email=o.email; address=o.address; }}
        el.innerHTML = ownerName
          ? `<div><b>${ownerName}</b></div><div>${phone}</div>${email?`<div>${email}</div>`:''}${address?`<div class='text-gray-600 mt-1'>${address}</div>`:''}`
          : `<div class='text-gray-500'>No owner linked.</div>`;
      })();

      renderProcedures();
    }

    function renderProcedures(){
      repoGetPet(id).then(p=>{
        const list = (p?.procedures||[]);
        const tbody = document.getElementById('procRows');
        if(!tbody) return;
        tbody.innerHTML = list.map((pr,idx)=>`
          <tr class="border-b">
            <td class="py-3">${pr.performedAt||''}</td>
            <td class="py-3">${pr.category||''}</td>
            <td class="py-3">${pr.name||''}</td>
            <td class="py-3">${pr.notes||''}</td>
            <td class="py-3">${pr.medications||''}</td>
            <td class="py-3">${pr.dosage||''}</td>
            <td class="py-3">${pr.directions||''}</td>
            <td class="py-3">${Number(pr.cost||0).toLocaleString()}</td>
            <td class="py-3">
              <button class="px-2 py-1 border rounded-md mr-2 text-sm" onclick="openProc(${idx})">Edit</button>
              <button class="px-2 py-1 border rounded-md text-sm text-red-600" onclick="delProc(${idx})">Delete</button>
            </td>
          </tr>`).join('') || `<tr><td class="py-3" colspan="9">No procedures recorded.</td></tr>`;
        const total = list.reduce((s,pr)=>s+Number(pr.cost||0),0);
        document.getElementById('procTotal').textContent = total.toLocaleString();
      });
    }

    async function openProc(editIndex){
      await fetchProcedureCatalog();
      const wrap=document.createElement('div');
      wrap.innerHTML=`
        <div class="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl w-full max-w-xl p-6">
            <h3 class="text-xl font-semibold mb-4">${editIndex!=null?'Edit':'Add'} Procedure</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="text-sm text-gray-600">Category
                <select id="pr_category" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                  <option value=""></option>
                  <option>Consultation & Check-up</option>
                  <option>Vaccine & Deworming</option>
                  <option>Laboratory Tests</option>
                  <option>Rapid Tests</option>
                  <option>Surgical Service</option>
                  <option>Spaying & Castration</option>
                </select>
              </label>
              <label id="wrap_type" class="text-sm text-gray-600 hidden">Procedure Type
                <select id="pr_type" class="w-full border border-gray-300 rounded-md p-3 mt-1"></select>
              </label>
              <label id="wrap_labType" class="text-sm text-gray-600 hidden">Lab Test Type
                <select id="pr_labType" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                  <option value=""></option>
                  <option>Complete Blood Count (CBC)</option>
                  <option>Comprehensive Blood</option>
                  <option>Chemistry 10 Panel</option>
                  <option>Chemistry 24 Panel</option>
                  <option>X-ray</option>
                  <option>Ultrasound OB</option>
                  <option>Ultrasound</option>
                  <option>Incubator</option>
                  <option>2D ECHO</option>
                  <option>ECG</option>
                  <option>PCR Test</option>
                  <option>Rivalta Test</option>
                  <option>Urinalysis</option>
                  <option>Fecalysis</option>
                  <option>Immunofluorescence Assay Test</option>
                  <option>Ear Smear Test</option>
                  <option>Oxygen Chamber</option>
                  <option>Nebulization Treatment</option>
                  <option>Pet iChip Standard</option>
                  <option>Laser Therapy (6 sessions)</option>
                </select>
              </label>
              <label class="text-sm text-gray-600">Performed At
                <input id="pr_performedAt" type="date" class="w-full border border-gray-300 rounded-md p-3 mt-1">
              </label>
              <label class="text-sm text-gray-600">Name
                <input id="pr_name" class="w-full border border-gray-300 rounded-md p-3 mt-1" placeholder="e.g., Vaccination">
              </label>
              <input type="hidden" id="pr_code">
              <label class="text-sm text-gray-600 md:col-span-2">Notes
                <input id="pr_notes" class="w-full border border-gray-300 rounded-md p-3 mt-1">
              </label>
              <label class="text-sm text-gray-600 md:col-span-2">Medications
                <input id="pr_meds" class="w-full border border-gray-300 rounded-md p-3 mt-1" placeholder="Comma-separated">
              </label>
              <label class="text-sm text-gray-600">Dosage
                <input id="pr_dosage" class="w-full border border-gray-300 rounded-md p-3 mt-1">
              </label>
              <label class="text-sm text-gray-600">Directions
                <input id="pr_dirs" class="w-full border border-gray-300 rounded-md p-3 mt-1">
              </label>
              <label class="text-sm text-gray-600">Cost (â‚±)
                <input id="pr_cost" type="number" step="0.01" min="0" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="0" readonly>
              </label>
            </div>
            <div class="mt-5 flex justify-end gap-3">
              <button class="px-4 py-2 border rounded-md" onclick="this.closest('.fixed').remove()">Cancel</button>
              <button class="px-5 py-2 rounded-md bg-[var(--soft-teal)] text-white" onclick="saveProc(${editIndex!=null?editIndex:''})">Save</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(wrap);
      // keyboard shortcuts for save/cancel
      function onKey(e){ if(e.key==='Enter'){ e.preventDefault(); saveProc(editIndex); } if(e.key==='Escape'){ e.preventDefault(); document.querySelector('.fixed.inset-0')?.remove(); } }
      wrap.addEventListener('keydown', onKey);
      // defaults
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('pr_performedAt').value = today;
      const catEl = document.getElementById('pr_category');
      const labWrap = document.getElementById('wrap_labType');
      const labEl = document.getElementById('pr_labType');
      const typeWrap = document.getElementById('wrap_type');
      const typeEl = document.getElementById('pr_type');
      const medsEl = document.getElementById('pr_meds');
      const dosageEl = document.getElementById('pr_dosage');
      const dirsEl = document.getElementById('pr_dirs');
      const codeEl = document.getElementById('pr_code');
      function syncLabVisibility(){
        const isLab = catEl.value === 'Laboratory Tests';
        labWrap.classList.toggle('hidden', !isLab);
        if(!isLab){ labEl.value=''; }
        // If a lab type is chosen, mirror to name (still editable)
        if(isLab && labEl.value){ document.getElementById('pr_name').value = labEl.value; }
      }
      catEl.addEventListener('change', syncLabVisibility);
      labEl.addEventListener('change', ()=>{ if(labEl.value){ document.getElementById('pr_name').value = labEl.value; } });
      function populateTypes(){
        const cat = catEl.value;
        const catalog = (window.PROCEDURE_CATALOG||{})[cat]||[];
        typeWrap.classList.toggle('hidden', catalog.length===0);
        typeEl.innerHTML = `<option value=""></option>` + catalog.map(i=>`<option value="${i.code||i.name}">${i.name}</option>`).join('');
      }
      catEl.addEventListener('change', ()=>{ populateTypes(); applySelectedType(); });
      typeEl.addEventListener('change', applySelectedType);
      function applySelectedType(){
        const cat = catEl.value;
        const typeKey = typeEl.value;
        const catalog = (window.PROCEDURE_CATALOG||{})[cat]||[];
        const item = catalog.find(i=>i.code===typeKey || i.name===typeKey);
        if(item){
          document.getElementById('pr_name').value = item.name;
          document.getElementById('pr_cost').value = Number(item.cost||0);
          codeEl.value = item.code || '';
          if(item.medications){ medsEl.value = item.medications; }
          if(item.dosage){ dosageEl.value = item.dosage; }
          if(item.directions){ dirsEl.value = item.directions; }
          if(item.directions && !document.getElementById('pr_notes').value){ document.getElementById('pr_notes').value = item.directions; }
        }
      }
      populateTypes();
      document.getElementById('pr_name').focus();
      if(editIndex!=null){
        repoGetPet(id).then(p=>{ const pr=p.procedures[editIndex]; if(!pr) return; document.getElementById('pr_performedAt').value=pr.performedAt||today; document.getElementById('pr_name').value=pr.name||''; document.getElementById('pr_notes').value=pr.notes||''; medsEl.value=pr.medications||''; dosageEl.value=pr.dosage||''; dirsEl.value=pr.directions||''; document.getElementById('pr_cost').value=Number(pr.cost||0); catEl.value=pr.category||''; populateTypes(); const existingCatalog = (window.PROCEDURE_CATALOG||{})[pr.category]||[]; const match = existingCatalog.find(item=>item.code===pr.procedureCode || item.code===pr.code || item.name===pr.name); typeEl.value = match ? (match.code||match.name) : (pr.procedureCode||pr.code||pr.name||''); codeEl.value = pr.procedureCode || pr.code || match?.code || ''; labEl.value=pr.labType||''; syncLabVisibility(); applySelectedType(); });
      }
    }
    async function saveProc(editIndex){
      const performedAt=document.getElementById('pr_performedAt').value || new Date().toISOString().slice(0,10);
      const name=document.getElementById('pr_name').value.trim();
      const notes=document.getElementById('pr_notes').value.trim();
      const medications=document.getElementById('pr_meds').value.trim();
      const cost=Number(document.getElementById('pr_cost').value||0);
      const category=document.getElementById('pr_category').value;
      const labType=(document.getElementById('pr_labType')?.value||'');
      const dosage=document.getElementById('pr_dosage').value.trim();
      const directions=document.getElementById('pr_dirs').value.trim();
      const procedureCode=document.getElementById('pr_code').value.trim();
      if(category==='Laboratory Tests' && !labType){ alert('Lab Test Type is required for Laboratory Tests'); return; }
      if(!name){alert('Procedure name is required');return;}
      const payload={performedAt,name,notes,medications,cost,category,labType,dosage,directions,procedureCode};
      if(editIndex!=null){ await repoUpdateProcedure(id, editIndex, payload); }
      else { await repoAddProcedure(id,payload); }
      document.querySelector('.fixed.inset-0')?.remove();
      renderProcedures();
    }

    async function delProc(idx){ if(confirm('Delete this procedure?')){ await repoDeleteProcedure(id, idx); renderProcedures(); } }

    renderProfile();
  </script>
</body>
</html>
